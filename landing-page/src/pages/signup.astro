---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Sign Up | PkgWatch" mainClass="max-w-md mx-auto px-4 py-24 pt-24">
  <!-- Content hidden until auth check completes -->
  <div id="signup-content" class="opacity-0 transition-opacity duration-150">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-white mb-4">Get Your Free API Key</h1>
      <p class="text-zinc-400">
        Start with 5,000 free requests per month. No credit card required.
      </p>
    </div>

    <form id="signup-form" class="space-y-6">
      <div>
        <label for="email" class="block text-sm font-medium text-zinc-300 mb-2">
          Email Address
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          autocomplete="email"
          aria-describedby="error-message"
          class="w-full px-4 py-3 bg-[#0d0d10] border border-zinc-800 rounded-lg
                 text-white placeholder-zinc-500 focus:border-blue-500
                 focus:ring-1 focus:ring-blue-500 outline-none transition"
          placeholder="you@company.com"
        />
      </div>

      <button
        type="submit"
        class="w-full btn-gradient px-6 py-3 rounded-lg font-semibold
               text-white transition hover:opacity-90 disabled:opacity-50"
      >
        <span id="btn-text">Get API Key</span>
        <span id="btn-loading" class="hidden">Sending...</span>
      </button>

      <p id="error-message" class="text-red-400 text-sm hidden" role="alert" aria-live="polite"></p>
      <p id="success-message" class="text-emerald-400 text-sm hidden" role="status" aria-live="polite"></p>

      <!-- Resend verification email (shown after success) -->
      <div id="resend-container" class="hidden mt-4 p-4 bg-zinc-900/50 border border-zinc-800 rounded-lg">
        <p class="text-zinc-400 text-sm mb-3">
          Didn't receive the email? Check your spam folder first, then try resending.
        </p>
        <button
          id="resend-btn"
          type="button"
          class="text-blue-400 hover:text-blue-300 text-sm font-medium underline underline-offset-2 disabled:opacity-50 disabled:no-underline disabled:cursor-not-allowed"
        >
          <span id="resend-text">Resend verification email</span>
          <span id="resend-cooldown" class="hidden"></span>
        </button>
      </div>
    </form>

    <div class="mt-8 text-center text-sm text-zinc-500">
      Already have an account?{' '}
      <a href="/login" class="text-blue-400 hover:text-blue-300">
        Sign in
      </a>
    </div>
  </div>
</Layout>

<script>
  const API_BASE = 'https://api.pkgwatch.laranjo.dev';
  const AUTH_CACHE_KEY = 'pkgwatch_auth_cache';

  // Check cache first for instant redirect (no flash)
  const cached = sessionStorage.getItem(AUTH_CACHE_KEY);
  if (cached) {
    try {
      const auth = JSON.parse(cached);
      if (auth.isLoggedIn) {
        // Hide everything during redirect to prevent any flash
        document.body.style.visibility = 'hidden';
        window.location.href = '/dashboard';
      }
    } catch {}
  }

  // Listen for auth validation from Navbar
  window.addEventListener('auth-state-changed', (e: Event) => {
    const detail = (e as CustomEvent).detail;
    if (detail?.user && !detail?.fromCache) {
      // Validated as logged in - redirect
      document.body.style.visibility = 'hidden';
      window.location.href = '/dashboard';
    } else if (!detail?.user && !detail?.fromCache) {
      // Validated as logged out - show form
      document.getElementById('signup-content')?.classList.remove('opacity-0');
    }
  });

  // If no cache, wait for validation then show form
  if (!cached && window.pkgwatchAuth?.checked && !window.pkgwatchAuth.isLoggedIn) {
    document.getElementById('signup-content')?.classList.remove('opacity-0');
  }

  const form = document.getElementById('signup-form');
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const errorMsg = document.getElementById('error-message');
  const successMsg = document.getElementById('success-message');

  // Resend elements
  const resendContainer = document.getElementById('resend-container');
  const resendBtn = document.getElementById('resend-btn') as HTMLButtonElement;
  const resendText = document.getElementById('resend-text');
  const resendCooldown = document.getElementById('resend-cooldown');

  // State
  let lastSubmittedEmail = '';
  let resendTimeoutId: number | null = null;
  let buttonCooldownTimeoutId: number | null = null;
  let resendCooldownTimeoutId: number | null = null;

  // Cleanup function to prevent memory leaks on navigation
  function cleanupTimeouts(): void {
    if (resendTimeoutId) clearTimeout(resendTimeoutId);
    if (buttonCooldownTimeoutId) clearTimeout(buttonCooldownTimeoutId);
    if (resendCooldownTimeoutId) clearTimeout(resendCooldownTimeoutId);
  }
  window.addEventListener('beforeunload', cleanupTimeouts);

  // Predefined error messages (prevents URL-based phishing)
  const ERROR_MESSAGES: Record<string, string> = {
    'invalid_token': 'Invalid or expired verification link. Please sign up again.',
    'token_expired': 'Your verification link has expired. Please sign up again.',
    'token_already_used': 'This verification link has already been used. Please sign up again.',
    'email_exists': 'An account with this email already exists. Please sign in instead.',
    'internal_error': 'Something went wrong. Please try again.',
  };

  // Check for error params from verification callback redirects
  function handleErrorParams(): void {
    const params = new URLSearchParams(window.location.search);
    const errorCode = params.get('error');

    if (errorCode && errorMsg) {
      const message = ERROR_MESSAGES[errorCode] || 'An error occurred. Please try again.';
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
      window.history.replaceState({}, '', '/signup');
    }
  }

  // Run on page load
  handleErrorParams();

  // Show resend option after delay
  function showResendAfterDelay(delayMs: number = 30000): void {
    if (resendTimeoutId) {
      clearTimeout(resendTimeoutId);
    }
    resendTimeoutId = window.setTimeout(() => {
      resendContainer?.classList.remove('hidden');
    }, delayMs);
  }

  // Handle button cooldown after success
  function startButtonCooldown(seconds: number): void {
    if (!submitBtn || !btnText) return;

    // Clear any existing cooldown
    if (buttonCooldownTimeoutId) {
      clearTimeout(buttonCooldownTimeoutId);
    }

    submitBtn.disabled = true;
    let remaining = seconds;

    const updateCooldown = () => {
      btnText.textContent = `Submit again in ${remaining}s`;
      remaining--;

      if (remaining < 0) {
        submitBtn.disabled = false;
        btnText.textContent = 'Get API Key';
        buttonCooldownTimeoutId = null;
      } else {
        buttonCooldownTimeoutId = window.setTimeout(updateCooldown, 1000);
      }
    };
    updateCooldown();
  }

  // Handle resend cooldown UI
  function startResendCooldown(seconds: number): void {
    if (!resendBtn || !resendText || !resendCooldown) return;

    // Clear any existing cooldown
    if (resendCooldownTimeoutId) {
      clearTimeout(resendCooldownTimeoutId);
    }

    resendBtn.disabled = true;
    resendText.classList.add('hidden');
    resendCooldown.classList.remove('hidden');

    let remaining = seconds;
    const updateCooldown = () => {
      if (resendCooldown) {
        resendCooldown.textContent = `Wait ${remaining}s to resend`;
      }
      remaining--;

      if (remaining < 0) {
        // Cooldown complete
        resendBtn.disabled = false;
        resendText?.classList.remove('hidden');
        resendCooldown?.classList.add('hidden');
        resendCooldownTimeoutId = null;
      } else {
        resendCooldownTimeoutId = window.setTimeout(updateCooldown, 1000);
      }
    };
    updateCooldown();
  }

  // Handle resend click
  async function handleResend(): Promise<void> {
    if (!lastSubmittedEmail) return;

    // Disable button immediately
    if (resendBtn) resendBtn.disabled = true;
    errorMsg?.classList.add('hidden');

    try {
      const response = await fetch(`${API_BASE}/auth/resend-verification`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: lastSubmittedEmail }),
      });

      const data = await response.json();

      if (response.ok) {
        if (successMsg) successMsg.textContent = data.message || 'Verification email resent!';
        successMsg?.classList.remove('hidden');
        // Start 60-second cooldown
        startResendCooldown(60);
      } else if (response.status === 429) {
        // Cooldown error from server - extract remaining seconds
        const match = data.error?.message?.match(/(\d+) seconds/);
        const remaining = match ? parseInt(match[1]) : 60;
        startResendCooldown(remaining);
        if (errorMsg) errorMsg.textContent = data.error?.message || 'Please wait before requesting another email.';
        errorMsg?.classList.remove('hidden');
      } else {
        if (errorMsg) errorMsg.textContent = data.error?.message || 'Failed to resend email.';
        errorMsg?.classList.remove('hidden');
        if (resendBtn) resendBtn.disabled = false;
      }
    } catch (error) {
      if (errorMsg) errorMsg.textContent = 'Network error. Please try again.';
      errorMsg?.classList.remove('hidden');
      if (resendBtn) resendBtn.disabled = false;
    }
  }

  // Main form submit handler
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = emailInput?.value || '';
    lastSubmittedEmail = email;

    // Hide resend container and reset state
    resendContainer?.classList.add('hidden');
    if (resendTimeoutId) {
      clearTimeout(resendTimeoutId);
      resendTimeoutId = null;
    }

    // Disable button and show loading state
    if (submitBtn) submitBtn.disabled = true;
    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    errorMsg?.classList.add('hidden');
    successMsg?.classList.add('hidden');

    try {
      const response = await fetch(`${API_BASE}/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (response.ok) {
        if (successMsg) successMsg.textContent = data.message || 'Check your email (including spam folder) for a verification link!';
        successMsg?.classList.remove('hidden');
        form?.reset();
        // Show resend option after 30 seconds
        showResendAfterDelay(30000);
        // Start button cooldown
        btnLoading?.classList.add('hidden');
        btnText?.classList.remove('hidden');
        startButtonCooldown(30);
      } else {
        if (errorMsg) errorMsg.textContent = data.error?.message || 'Something went wrong';
        errorMsg?.classList.remove('hidden');
        // Re-enable button on error
        if (submitBtn) submitBtn.disabled = false;
        btnText?.classList.remove('hidden');
        btnLoading?.classList.add('hidden');
      }
    } catch (error) {
      if (errorMsg) errorMsg.textContent = 'Network error. Please try again.';
      errorMsg?.classList.remove('hidden');
      // Re-enable button on error
      if (submitBtn) submitBtn.disabled = false;
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  });

  // Resend button click handler
  resendBtn?.addEventListener('click', handleResend);
</script>

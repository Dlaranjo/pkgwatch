---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Dashboard | PkgWatch" mainClass="max-w-4xl mx-auto px-4 py-24 pt-32">
    <!-- Loading Skeleton (shown initially) -->
    <div id="dashboard-skeleton" class="space-y-8 animate-fade-in-up">
      <!-- Profile skeleton -->
      <div class="animate-pulse">
        <div class="h-8 bg-zinc-800 rounded w-48 mb-4"></div>
        <div class="h-4 bg-zinc-800 rounded w-32"></div>
      </div>
      <!-- Usage card skeleton -->
      <div class="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 animate-pulse">
        <div class="h-5 bg-zinc-800 rounded w-24 mb-4"></div>
        <div class="h-2 bg-zinc-800 rounded w-full mb-3"></div>
        <div class="h-4 bg-zinc-800 rounded w-40"></div>
      </div>
      <!-- Keys card skeleton -->
      <div class="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 animate-pulse">
        <div class="flex justify-between items-center mb-6">
          <div class="h-5 bg-zinc-800 rounded w-24"></div>
          <div class="h-9 bg-zinc-800 rounded w-28"></div>
        </div>
        <div class="space-y-4">
          <div class="h-14 bg-zinc-800 rounded"></div>
          <div class="h-14 bg-zinc-800 rounded"></div>
        </div>
      </div>
    </div>

    <!-- Auth Error State (hidden by default) -->
    <div id="auth-error" class="hidden text-center py-16 animate-fade-in-up">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-900/30 flex items-center justify-center">
        <svg aria-hidden="true" class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0H10m2-10a4 4 0 00-4 4v4h8v-4a4 4 0 00-4-4z"></path>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2">Session Expired</h1>
      <p class="text-zinc-400 mb-6">Please sign in again to access your dashboard.</p>
      <a href="/login" class="inline-block px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition">
        Sign In
      </a>
    </div>

    <!-- Dashboard Content (hidden until loaded) -->
    <div id="dashboard-content" class="hidden space-y-8 animate-fade-in-up">
      <!-- Profile Header -->
      <section aria-labelledby="profile-heading">
        <h1 id="profile-heading" class="text-3xl font-bold text-white mb-2">Welcome back</h1>
        <div class="flex items-center gap-3 flex-wrap">
          <span id="user-email" class="text-zinc-400">loading...</span>
          <span id="user-tier" class="px-3 py-1 text-xs font-semibold rounded-full bg-emerald-500/20 text-emerald-400 uppercase">
            Free
          </span>
          <!-- Manage Subscription Button (hidden for free tier, aligned right) -->
          <button
            id="manage-subscription-btn"
            class="hidden ml-auto px-3 py-1.5 text-xs font-medium text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-500 rounded-lg transition flex items-center gap-1.5"
          >
            <svg aria-hidden="true" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span id="manage-subscription-text">Manage Subscription</span>
            <svg aria-hidden="true" id="manage-subscription-loading" class="hidden w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
          </button>
        </div>
      </section>

      <!-- Cancellation Pending Banner -->
      <div id="cancellation-banner" class="hidden bg-amber-500/10 border border-amber-500/30 rounded-lg p-4">
        <p class="text-amber-400 text-sm flex items-center gap-2">
          <svg aria-hidden="true" class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>
            Your <span id="cancel-tier" class="font-semibold">Pro</span> subscription will end on
            <span id="cancel-date" class="font-semibold">February 15, 2024</span>.
            You'll retain full access until then.
          </span>
        </p>
      </div>

      <!-- Usage Stats Card -->
      <section aria-labelledby="usage-heading" class="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
        <h2 id="usage-heading" class="text-lg font-semibold text-white mb-4">API Usage</h2>

        <div class="mb-4">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-zinc-400">Requests this month</span>
            <span id="usage-count" class="text-white font-medium">0 / 100</span>
          </div>
          <div class="h-2 bg-zinc-800 rounded-full overflow-hidden" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="usage-bar-container">
            <div id="usage-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>

        <p id="reset-info" class="text-sm text-zinc-500">
          Loading reset date...
        </p>
      </section>

      <!-- API Keys Section -->
      <section aria-labelledby="keys-heading" class="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
        <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
          <h2 id="keys-heading" class="text-lg font-semibold text-white">API Keys</h2>
          <button
            id="create-key-btn"
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition flex items-center gap-2"
          >
            <svg aria-hidden="true" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span id="create-key-text">Create Key</span>
            <svg aria-hidden="true" id="create-key-loading" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
          </button>
        </div>

        <!-- Error message -->
        <div id="keys-error" class="hidden mb-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
          <p class="text-sm text-red-400 flex items-center gap-2" id="keys-error-text">
            <svg aria-hidden="true" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="keys-error-message">An error occurred</span>
          </p>
        </div>

        <!-- Max keys warning -->
        <div id="max-keys-warning" class="hidden mb-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
          <p class="text-sm text-yellow-400 flex items-center gap-2">
            <svg aria-hidden="true" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            Maximum of 5 API keys reached. Revoke an existing key to create a new one.
          </p>
        </div>

        <!-- Keys table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="keys-table">
            <thead>
              <tr class="text-left text-zinc-400 border-b border-zinc-800">
                <th scope="col" class="pb-3 font-medium">Key</th>
                <th scope="col" class="pb-3 font-medium">Created</th>
                <th scope="col" class="pb-3 font-medium hidden sm:table-cell">Requests</th>
                <th scope="col" class="pb-3 font-medium sr-only">Actions</th>
              </tr>
            </thead>
            <tbody id="keys-body" class="text-zinc-300">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Empty state -->
        <div id="no-keys" class="hidden text-center py-8">
          <p class="text-zinc-400">No API keys found. Create one to get started.</p>
        </div>
      </section>

      <!-- Quick Links -->
      <section class="grid sm:grid-cols-3 gap-4">
        <a href="/docs" class="p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl hover:border-zinc-700 transition group">
          <h3 class="font-medium text-white group-hover:text-blue-400 transition">API Docs</h3>
          <p class="text-sm text-zinc-500">Learn how to use the API</p>
        </a>
        <a href="/docs#cli-tool" class="p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl hover:border-zinc-700 transition group">
          <h3 class="font-medium text-white group-hover:text-blue-400 transition">CLI Setup</h3>
          <p class="text-sm text-zinc-500">Install the command line tool</p>
        </a>
        <a href="/pricing" class="p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl hover:border-zinc-700 transition group">
          <h3 class="font-medium text-white group-hover:text-blue-400 transition">Upgrade</h3>
          <p class="text-sm text-zinc-500">Get more requests</p>
        </a>
      </section>
    </div>

  <!-- New Key Modal -->
  <div id="new-key-modal" class="hidden fixed inset-0 z-50" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="modal-backdrop"></div>

    <!-- Modal content -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
      <div class="bg-[#111113] border border-zinc-800 rounded-xl max-w-lg w-full shadow-2xl" role="document">
        <!-- Warning header -->
        <div class="p-4 bg-yellow-900/20 border-b border-yellow-500/30 rounded-t-xl">
          <p class="text-sm text-yellow-400 flex items-center gap-2">
            <svg aria-hidden="true" class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <span><strong>Important:</strong> This key will only be shown once. Copy it now!</span>
          </p>
        </div>

        <!-- Countdown timer (shown for new verification) -->
        <div id="key-timer-container" class="hidden px-4 py-2 bg-zinc-900 border-b border-zinc-800">
          <p class="text-sm flex items-center justify-center gap-2">
            <svg aria-hidden="true" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="key-timer" class="font-mono text-emerald-400">5:00</span>
            <span class="text-zinc-400">remaining to copy this key</span>
          </p>
        </div>

        <!-- Modal body -->
        <div class="p-6">
          <h2 id="modal-title" class="text-xl font-bold text-white mb-4">Your New API Key</h2>

          <div class="relative">
            <input
              type="text"
              id="new-key-value"
              readonly
              class="w-full px-4 py-3 pr-24 bg-black/50 border border-zinc-700 rounded-lg font-mono text-sm text-emerald-400 select-all focus:outline-none focus:ring-2 focus:ring-emerald-500"
              aria-label="Your new API key"
            />
            <button
              id="copy-key-btn"
              class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 text-white text-xs font-medium rounded transition flex items-center gap-1"
            >
              <svg aria-hidden="true" id="copy-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
              </svg>
              <svg aria-hidden="true" id="check-icon" class="w-4 h-4 hidden text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <span id="copy-text">Copy</span>
            </button>
          </div>

          <div class="mt-6">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="confirm-saved" class="w-4 h-4 rounded border-zinc-600 bg-zinc-800 text-emerald-500 focus:ring-emerald-500 focus:ring-offset-0">
              <span class="text-sm text-zinc-400">I have copied and saved this API key</span>
            </label>
          </div>
        </div>

        <!-- Modal footer -->
        <div class="p-4 border-t border-zinc-800 flex justify-end">
          <button
            id="close-modal-btn"
            disabled
            class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition"
          >
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Revoke Confirmation Modal -->
  <div id="revoke-modal" class="hidden fixed inset-0 z-50" role="dialog" aria-modal="true" aria-labelledby="revoke-title">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="revoke-backdrop"></div>

    <!-- Modal content -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
      <div class="bg-[#111113] border border-zinc-800 rounded-xl max-w-md w-full shadow-2xl" role="document">
        <div class="p-6">
          <h2 id="revoke-title" class="text-xl font-bold text-white mb-2">Revoke API Key</h2>
          <p class="text-zinc-400 mb-4">Are you sure you want to revoke this key? This action cannot be undone.</p>

          <div class="p-3 bg-zinc-900 border border-zinc-800 rounded-lg mb-4">
            <div class="font-mono text-sm text-zinc-300" id="revoke-key-prefix">pw_abc123...</div>
            <div class="text-xs text-zinc-500 mt-1" id="revoke-key-info">Created 3 days ago</div>
          </div>

          <div id="last-key-warning" class="hidden p-3 bg-red-900/20 border border-red-500/30 rounded-lg mb-4">
            <p class="text-sm text-red-400 flex items-center gap-2">
              <svg aria-hidden="true" class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              This is your only API key. You must keep at least one active key.
            </p>
          </div>
        </div>

        <div class="p-4 border-t border-zinc-800 flex gap-3 justify-end">
          <button
            id="cancel-revoke-btn"
            class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-white text-sm font-medium rounded-lg transition"
          >
            Cancel
          </button>
          <button
            id="confirm-revoke-btn"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition flex items-center gap-2"
          >
            <span id="revoke-text">Revoke Key</span>
            <svg aria-hidden="true" id="revoke-loading" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const API_BASE = 'https://api.pkgwatch.laranjo.dev';

  // DOM Elements
  const skeleton = document.getElementById('dashboard-skeleton');
  const authError = document.getElementById('auth-error');
  const content = document.getElementById('dashboard-content');
  const userEmail = document.getElementById('user-email');
  const userTier = document.getElementById('user-tier');
  const usageCount = document.getElementById('usage-count');
  const usageBar = document.getElementById('usage-bar');
  const usageBarContainer = document.getElementById('usage-bar-container');
  const keysBody = document.getElementById('keys-body');
  const createKeyBtn = document.getElementById('create-key-btn');
  const maxKeysWarning = document.getElementById('max-keys-warning');
  const keysError = document.getElementById('keys-error');
  const keysErrorMessage = document.getElementById('keys-error-message');
  const noKeys = document.getElementById('no-keys');
  const manageSubscriptionBtn = document.getElementById('manage-subscription-btn');
  const cancellationBanner = document.getElementById('cancellation-banner');
  const cancelTier = document.getElementById('cancel-tier');
  const cancelDate = document.getElementById('cancel-date');

  // Modal elements
  const newKeyModal = document.getElementById('new-key-modal');
  const newKeyValue = document.getElementById('new-key-value') as HTMLInputElement;
  const copyKeyBtn = document.getElementById('copy-key-btn');
  const confirmSaved = document.getElementById('confirm-saved') as HTMLInputElement;
  const closeModalBtn = document.getElementById('close-modal-btn') as HTMLButtonElement;

  const revokeModal = document.getElementById('revoke-modal');
  const revokeKeyPrefix = document.getElementById('revoke-key-prefix');
  const revokeKeyInfo = document.getElementById('revoke-key-info');
  const lastKeyWarning = document.getElementById('last-key-warning');
  const cancelRevokeBtn = document.getElementById('cancel-revoke-btn');
  const confirmRevokeBtn = document.getElementById('confirm-revoke-btn') as HTMLButtonElement;

  // Timer elements
  const keyTimerContainer = document.getElementById('key-timer-container');
  const keyTimer = document.getElementById('key-timer');

  // State
  interface ApiKey {
    key_id: string;
    key_prefix: string;
    tier: string;
    requests_this_month: number;
    created_at: string;
    last_used: string | null;
  }

  let apiKeys: ApiKey[] = [];
  let keyToRevoke: string | null = null;
  let countdownInterval: number | null = null;

  // Utility functions
  function formatNumber(num: number): string {
    return num.toLocaleString();
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function getRelativeTime(dateStr: string): string {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    // Handle future dates (clock skew) - treat as "today"
    if (diffDays < 0) return 'today';
    if (diffDays === 0) return 'today';
    if (diffDays === 1) return 'yesterday';
    if (diffDays < 30) return `${diffDays} days ago`;
    const months = Math.floor(diffDays / 30);
    if (diffDays < 365) return months === 1 ? '1 month ago' : `${months} months ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  async function copyToClipboard(text: string): Promise<boolean> {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (err) {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.cssText = 'position:absolute;left:-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        return true;
      } catch {
        return false;
      } finally {
        document.body.removeChild(textarea);
      }
    }
  }

  // API Functions
  async function fetchWithAuth(url: string, options: RequestInit = {}): Promise<Response> {
    const response = await fetch(url, {
      ...options,
      credentials: 'include',
      cache: 'no-store',
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
    });

    if (response.status === 401) {
      throw new Error('UNAUTHORIZED');
    }

    if (response.status === 429) {
      const data = await response.json();
      const match = data.error?.message?.match(/(\d+) seconds/);
      const waitTime = match ? parseInt(match[1]) : 60;
      throw new Error(`Rate limited. Please wait ${waitTime} seconds.`);
    }

    return response;
  }

  async function loadUserData(refresh: boolean = false): Promise<any> {
    // Add refresh=stripe param if returning from billing portal
    const url = refresh
      ? `${API_BASE}/auth/me?refresh=stripe`
      : `${API_BASE}/auth/me`;

    const response = await fetchWithAuth(url);
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error?.message || 'Failed to load user data');
    }
    return response.json();
  }

  async function loadApiKeys(): Promise<any> {
    const response = await fetchWithAuth(`${API_BASE}/api-keys`);
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error?.message || 'Failed to load API keys');
    }
    return response.json();
  }

  async function createApiKey(): Promise<any> {
    const response = await fetchWithAuth(`${API_BASE}/api-keys`, {
      method: 'POST',
      body: JSON.stringify({}),
    });
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error?.message || 'Failed to create API key');
    }
    return response.json();
  }

  async function revokeApiKey(keyId: string): Promise<boolean> {
    const response = await fetchWithAuth(`${API_BASE}/api-keys/${keyId}`, {
      method: 'DELETE',
    });

    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error?.message || 'Failed to revoke key');
    }

    return true;
  }

  async function getPendingKey(): Promise<{api_key: string} | null> {
    try {
      const response = await fetchWithAuth(`${API_BASE}/auth/pending-key`);
      if (response.status === 404) {
        // No pending key (already retrieved or expired)
        return null;
      }
      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error?.message || 'Failed to get pending key');
      }
      return response.json();
    } catch (error: any) {
      if (error.message === 'UNAUTHORIZED') {
        throw error;
      }
      console.error('Failed to get pending key:', error);
      return null;
    }
  }

  async function createBillingPortalSession(): Promise<string> {
    const response = await fetchWithAuth(`${API_BASE}/billing-portal/create`, {
      method: 'POST',
    });
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error?.message || 'Failed to open billing portal');
    }
    const data = await response.json();
    return data.portal_url;
  }

  function startCountdown(seconds: number): void {
    // Stop any existing countdown
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }

    // Reset timer color in case modal was reopened
    keyTimer?.classList.remove('text-red-400');
    keyTimer?.classList.add('text-emerald-400');

    // Show timer container
    keyTimerContainer?.classList.remove('hidden');

    // Use timestamp-based calculation to prevent drift over time
    const endTime = Date.now() + (seconds * 1000);

    const updateTimer = () => {
      // Calculate remaining from actual time to prevent drift
      const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;
      const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;

      if (keyTimer) {
        keyTimer.textContent = timeStr;

        // Turn red when under 60 seconds
        if (remaining <= 60) {
          keyTimer.classList.remove('text-emerald-400');
          keyTimer.classList.add('text-red-400');
        }
      }

      // Check for expiration (remaining is 0, not negative)
      if (remaining <= 0) {
        // Timer expired
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        // Close modal and show warning
        closeNewKeyModal();
        showInlineError('Time expired! The key display window has closed. Your key is still active - you can view it in the table above (only the prefix is shown for security).');
      }
    };

    updateTimer();
    countdownInterval = window.setInterval(updateTimer, 1000);
  }

  function stopCountdown(): void {
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    keyTimerContainer?.classList.add('hidden');
    // Reset timer color
    keyTimer?.classList.remove('text-red-400');
    keyTimer?.classList.add('text-emerald-400');
  }

  // UI Update Functions
  function showAuthError(): void {
    // Close any open modals first
    closeNewKeyModal();
    closeRevokeModal();
    skeleton?.classList.add('hidden');
    content?.classList.add('hidden');
    authError?.classList.remove('hidden');
  }

  function showContent(): void {
    skeleton?.classList.add('hidden');
    authError?.classList.add('hidden');
    content?.classList.remove('hidden');
  }

  function showInlineError(message: string): void {
    if (keysErrorMessage) keysErrorMessage.textContent = message;
    keysError?.classList.remove('hidden');
    // Auto-hide after 5 seconds
    setTimeout(() => {
      keysError?.classList.add('hidden');
    }, 5000);
  }

  function hideInlineError(): void {
    keysError?.classList.add('hidden');
  }

  function formatUnixTimestamp(timestamp: number): string {
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric',
    });
  }

  function updateUserInfo(userData: any): void {
    if (userEmail) userEmail.textContent = userData.email;
    if (userTier) {
      const tier = userData.tier || 'free';
      userTier.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);

      // Update tier badge color
      userTier.classList.remove('bg-emerald-500/20', 'text-emerald-400', 'bg-purple-500/20', 'text-purple-400', 'bg-blue-500/20', 'text-blue-400');
      if (tier === 'pro') {
        userTier.classList.add('bg-purple-500/20', 'text-purple-400');
      } else if (tier === 'business') {
        userTier.classList.add('bg-blue-500/20', 'text-blue-400');
      } else {
        userTier.classList.add('bg-emerald-500/20', 'text-emerald-400');
      }

      // Show/hide manage subscription button based on tier
      if (manageSubscriptionBtn) {
        if (tier !== 'free') {
          manageSubscriptionBtn.classList.remove('hidden');
        } else {
          manageSubscriptionBtn.classList.add('hidden');
        }
      }
    }

    // Handle cancellation pending banner
    if (userData.cancellation_pending && userData.cancellation_date) {
      if (cancellationBanner) cancellationBanner.classList.remove('hidden');
      if (cancelTier) {
        const tier = userData.tier || 'free';
        cancelTier.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
      }
      if (cancelDate) {
        cancelDate.textContent = formatUnixTimestamp(userData.cancellation_date);
      }
    } else {
      if (cancellationBanner) cancellationBanner.classList.add('hidden');
    }
  }

  function updateUsage(userData: any): void {
    const requests = userData.requests_this_month || 0;
    const limit = userData.monthly_limit || 100;
    const percentage = Math.min((requests / limit) * 100, 100);

    if (usageCount) {
      usageCount.textContent = `${formatNumber(requests)} / ${formatNumber(limit)}`;
    }

    if (usageBar) {
      usageBar.style.width = `${percentage}%`;

      // Color coding for usage levels
      usageBar.classList.remove('bg-blue-500', 'bg-yellow-500', 'bg-red-500');
      if (percentage >= 90) {
        usageBar.classList.add('bg-red-500');
      } else if (percentage >= 75) {
        usageBar.classList.add('bg-yellow-500');
      } else {
        usageBar.classList.add('bg-blue-500');
      }
    }

    if (usageBarContainer) {
      usageBarContainer.setAttribute('aria-valuenow', String(Math.round(percentage)));
    }

    // Update reset date display based on tier and billing cycle
    const resetInfo = document.getElementById('reset-info');
    if (resetInfo) {
      const tier = userData.tier || 'free';
      const periodEnd = userData.current_period_end;

      if (tier === 'free' || !periodEnd) {
        // Free users and legacy paid users: 1st of month
        resetInfo.textContent = 'Resets on the 1st of each month';
      } else {
        // Paid users with billing cycle data
        const resetDate = new Date(periodEnd * 1000);
        const formatted = resetDate.toLocaleDateString('en-US', {
          month: 'long',
          day: 'numeric',
        });
        resetInfo.textContent = `Resets on ${formatted}`;
      }
    }
  }

  function updateKeysList(keys: any[]): void {
    apiKeys = keys;

    if (!keysBody) return;

    if (keys.length === 0) {
      keysBody.innerHTML = '';
      noKeys?.classList.remove('hidden');
      return;
    }

    noKeys?.classList.add('hidden');

    keysBody.innerHTML = keys.map(key => `
      <tr class="border-b border-zinc-800/50 hover:bg-zinc-800/30 transition">
        <td class="py-4">
          <code class="px-2 py-1 bg-black/30 rounded text-zinc-300 font-mono text-xs">
            ${escapeHtml(key.key_prefix)}
          </code>
        </td>
        <td class="py-4 text-zinc-400">${escapeHtml(getRelativeTime(key.created_at))}</td>
        <td class="py-4 text-zinc-400 hidden sm:table-cell">${formatNumber(key.requests_this_month || 0)}</td>
        <td class="py-4">
          <button
            class="revoke-btn px-3 py-1.5 text-xs text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded transition"
            data-key-id="${escapeHtml(key.key_id)}"
            data-key-prefix="${escapeHtml(key.key_prefix)}"
            data-key-requests="${key.requests_this_month || 0}"
            data-key-created="${escapeHtml(key.created_at)}"
            aria-label="Revoke key ${escapeHtml(key.key_prefix)}"
          >
            Revoke
          </button>
        </td>
      </tr>
    `).join('');

    // Update max keys warning and button state
    if (keys.length >= 5) {
      maxKeysWarning?.classList.remove('hidden');
      if (createKeyBtn) (createKeyBtn as HTMLButtonElement).disabled = true;
    } else {
      maxKeysWarning?.classList.add('hidden');
      if (createKeyBtn) (createKeyBtn as HTMLButtonElement).disabled = false;
    }

    // Add event listeners to revoke buttons
    document.querySelectorAll('.revoke-btn').forEach(btn => {
      btn.addEventListener('click', () => openRevokeModal(btn as HTMLElement));
    });
  }

  // Modal Functions
  function openNewKeyModal(apiKey: string): void {
    if (!newKeyModal || !newKeyValue) return;

    newKeyValue.value = apiKey;
    if (confirmSaved) confirmSaved.checked = false;
    if (closeModalBtn) closeModalBtn.disabled = true;

    // Reset copy button state
    document.getElementById('copy-icon')?.classList.remove('hidden');
    document.getElementById('check-icon')?.classList.add('hidden');
    const copyText = document.getElementById('copy-text');
    if (copyText) copyText.textContent = 'Copy';

    newKeyModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Focus and select the key input for easy copying
    setTimeout(() => {
      newKeyValue.focus();
      newKeyValue.select();
    }, 100);
  }

  function closeNewKeyModal(): void {
    newKeyModal?.classList.add('hidden');
    document.body.style.overflow = '';
    stopCountdown();
    createKeyBtn?.focus();
  }

  function openRevokeModal(btn: HTMLElement): void {
    const keyId = btn.dataset.keyId;
    const keyPrefix = btn.dataset.keyPrefix;
    const requests = btn.dataset.keyRequests;
    const created = btn.dataset.keyCreated;

    if (!keyId) return;

    keyToRevoke = keyId;

    if (revokeKeyPrefix) revokeKeyPrefix.textContent = `${keyPrefix}`;
    if (revokeKeyInfo) {
      revokeKeyInfo.textContent = `Created ${getRelativeTime(created || '')} - ${formatNumber(parseInt(requests || '0'))} requests`;
    }

    // Check if last key
    if (apiKeys.length === 1) {
      lastKeyWarning?.classList.remove('hidden');
      if (confirmRevokeBtn) confirmRevokeBtn.disabled = true;
    } else {
      lastKeyWarning?.classList.add('hidden');
      if (confirmRevokeBtn) confirmRevokeBtn.disabled = false;
    }

    revokeModal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    cancelRevokeBtn?.focus();
  }

  function closeRevokeModal(): void {
    revokeModal?.classList.add('hidden');
    document.body.style.overflow = '';
    keyToRevoke = null;
  }

  // Event Handlers
  async function handleCreateKey(): Promise<void> {
    const textEl = document.getElementById('create-key-text');
    const loadingEl = document.getElementById('create-key-loading');

    if (createKeyBtn) (createKeyBtn as HTMLButtonElement).disabled = true;
    textEl?.classList.add('hidden');
    loadingEl?.classList.remove('hidden');

    try {
      const data = await createApiKey();

      // Show the new key in modal
      openNewKeyModal(data.api_key);

      // Refresh the keys list
      const keysData = await loadApiKeys();
      updateKeysList(keysData.api_keys || []);

    } catch (error: any) {
      if (error.message === 'UNAUTHORIZED') {
        showAuthError();
      } else {
        console.error('Failed to create key:', error);
        // Show error inline instead of alert for better UX
        const errorMsg = error.message || 'Failed to create key. Please try again.';
        showInlineError(errorMsg);
      }
    } finally {
      if (createKeyBtn) (createKeyBtn as HTMLButtonElement).disabled = false;
      textEl?.classList.remove('hidden');
      loadingEl?.classList.add('hidden');
    }
  }

  async function handleRevokeKey(): Promise<void> {
    if (!keyToRevoke) return;

    const textEl = document.getElementById('revoke-text');
    const loadingEl = document.getElementById('revoke-loading');

    if (confirmRevokeBtn) confirmRevokeBtn.disabled = true;
    textEl?.classList.add('hidden');
    loadingEl?.classList.remove('hidden');

    try {
      await revokeApiKey(keyToRevoke);

      closeRevokeModal();

      // Refresh the keys list
      const keysData = await loadApiKeys();
      updateKeysList(keysData.api_keys || []);

    } catch (error: any) {
      if (error.message === 'UNAUTHORIZED') {
        showAuthError();
      } else {
        console.error('Failed to revoke key:', error);
        closeRevokeModal();
        showInlineError(error.message || 'Failed to revoke key. Please try again.');
      }
    } finally {
      if (confirmRevokeBtn) confirmRevokeBtn.disabled = false;
      textEl?.classList.remove('hidden');
      loadingEl?.classList.add('hidden');
    }
  }

  async function handleCopyKey(): Promise<void> {
    const key = newKeyValue?.value;
    if (!key) return;

    const success = await copyToClipboard(key);

    if (success) {
      const copyIcon = document.getElementById('copy-icon');
      const checkIcon = document.getElementById('check-icon');
      const copyText = document.getElementById('copy-text');

      copyIcon?.classList.add('hidden');
      checkIcon?.classList.remove('hidden');
      if (copyText) copyText.textContent = 'Copied!';

      // Reset after 2 seconds
      setTimeout(() => {
        copyIcon?.classList.remove('hidden');
        checkIcon?.classList.add('hidden');
        if (copyText) copyText.textContent = 'Copy';
      }, 2000);
    }
  }

  async function handleManageSubscription(): Promise<void> {
    const textEl = document.getElementById('manage-subscription-text');
    const loadingEl = document.getElementById('manage-subscription-loading');

    if (manageSubscriptionBtn) (manageSubscriptionBtn as HTMLButtonElement).disabled = true;
    textEl?.classList.add('hidden');
    loadingEl?.classList.remove('hidden');

    try {
      const portalUrl = await createBillingPortalSession();
      // Validate and redirect to Stripe Billing Portal (defense-in-depth)
      if (portalUrl?.startsWith('https://billing.stripe.com/')) {
        window.location.href = portalUrl;
      } else {
        showInlineError('Invalid billing portal URL received. Please try again.');
      }
    } catch (error: any) {
      if (error.message === 'UNAUTHORIZED') {
        showAuthError();
      } else {
        console.error('Failed to open billing portal:', error);
        showInlineError(error.message || 'Failed to open billing portal. Please try again.');
      }
    } finally {
      if (manageSubscriptionBtn) (manageSubscriptionBtn as HTMLButtonElement).disabled = false;
      textEl?.classList.remove('hidden');
      loadingEl?.classList.add('hidden');
    }
  }

  // Initialize
  async function init(): Promise<void> {
    try {
      // Check for portal_return param (returning from Stripe billing portal)
      const params = new URLSearchParams(window.location.search);
      const portalReturn = params.has('portal_return');

      // Load user data and API keys in parallel
      // If returning from billing portal, refresh subscription data from Stripe
      const [userData, keysData] = await Promise.all([
        loadUserData(portalReturn),
        loadApiKeys(),
      ]);

      if (userData.error) {
        showAuthError();
        return;
      }

      // Clean up portal_return param from URL
      if (portalReturn) {
        params.delete('portal_return');
        const newUrl = params.toString()
          ? `/dashboard?${params.toString()}`
          : '/dashboard';
        window.history.replaceState({}, '', newUrl);
      }

      updateUserInfo(userData);
      updateUsage(userData);
      updateKeysList(keysData.api_keys || []);

      showContent();

      // Check for stored redirect after login (e.g., from /login?redirect=/pricing)
      const storedRedirect = sessionStorage.getItem('pkgwatch_redirect');
      if (storedRedirect) {
        sessionStorage.removeItem('pkgwatch_redirect');
        window.location.href = storedRedirect;
        return;
      }

      // Check if user just verified their email (params already defined above)
      if (params.has('verified')) {
        // Clean up URL immediately
        window.history.replaceState({}, '', '/dashboard');

        // Fetch the pending key
        const pendingKeyData = await getPendingKey();
        if (pendingKeyData?.api_key) {
          // Show the key in modal with countdown timer
          openNewKeyModal(pendingKeyData.api_key);
          startCountdown(300); // 5 minutes
        }
      }

    } catch (error: any) {
      console.error('Failed to load dashboard:', error);
      showAuthError();
    }
  }

  // Focus trap utility for accessibility
  function trapFocus(modal: HTMLElement): void {
    const focusable = modal.querySelectorAll<HTMLElement>(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );
    const first = focusable[0];
    const last = focusable[focusable.length - 1];

    modal.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab') return;
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last?.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first?.focus();
      }
    });
  }

  // Set up focus traps for modals
  if (newKeyModal) trapFocus(newKeyModal);
  if (revokeModal) trapFocus(revokeModal);

  // Event Listeners
  createKeyBtn?.addEventListener('click', handleCreateKey);
  copyKeyBtn?.addEventListener('click', handleCopyKey);
  manageSubscriptionBtn?.addEventListener('click', handleManageSubscription);

  confirmSaved?.addEventListener('change', () => {
    if (closeModalBtn) closeModalBtn.disabled = !confirmSaved.checked;
  });

  closeModalBtn?.addEventListener('click', () => {
    if (confirmSaved?.checked) {
      closeNewKeyModal();
    }
  });

  cancelRevokeBtn?.addEventListener('click', closeRevokeModal);
  confirmRevokeBtn?.addEventListener('click', handleRevokeKey);

  // Close modals on backdrop click
  document.getElementById('modal-backdrop')?.addEventListener('click', () => {
    if (confirmSaved?.checked) {
      closeNewKeyModal();
    }
  });
  document.getElementById('revoke-backdrop')?.addEventListener('click', closeRevokeModal);

  // Close modals on Escape key
  document.addEventListener('keydown', (e: KeyboardEvent) => {
    if (e.key === 'Escape') {
      if (!newKeyModal?.classList.contains('hidden')) {
        if (confirmSaved?.checked) {
          closeNewKeyModal();
        }
      }
      if (!revokeModal?.classList.contains('hidden')) {
        closeRevokeModal();
      }
    }
  });

  // Start loading
  init();
</script>

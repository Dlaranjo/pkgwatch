---
import Layout from '../layouts/Layout.astro'
import Navbar from '../components/Navbar.astro'
import Footer from '../components/Footer.astro'

const endpoints = [
  {
    method: 'GET',
    path: '/v1/health',
    description: 'Health check endpoint. No authentication required.',
    auth: false,
    example: {
      request: 'curl https://api.dephealth.laranjo.dev/v1/health',
      response: `{
  "status": "healthy",
  "version": "1.0.0",
  "timestamp": "2026-01-07T20:00:00.000Z"
}`
    }
  },
  {
    method: 'GET',
    path: '/v1/packages/npm/{name}',
    description: 'Get health score and details for a single npm package.',
    auth: true,
    params: [
      { name: 'name', type: 'string', description: 'Package name (URL-encoded for scoped packages)' }
    ],
    example: {
      request: `curl -H "X-API-Key: YOUR_KEY" \\
  https://api.dephealth.laranjo.dev/v1/packages/npm/express`,
      response: `{
  "package": "express",
  "ecosystem": "npm",
  "health_score": 83.5,
  "risk_level": "LOW",
  "abandonment_risk": {
    "probability": 3.5,
    "time_horizon_months": 12,
    "components": {
      "bus_factor_risk": 0.4,
      "inactivity_risk": 0,
      "adoption_risk": 10,
      "release_risk": 9.4
    }
  },
  "components": {
    "maintainer_health": 100,
    "evolution_health": 86.5,
    "community_health": 73.7,
    "user_centric": 69.3,
    "security_health": 72.5
  },
  "signals": {
    "weekly_downloads": 37871062,
    "dependents_count": 0,
    "stars": 68517,
    "days_since_last_commit": 0,
    "commits_90d": 28,
    "active_contributors_90d": 11,
    "maintainer_count": 5,
    "is_deprecated": false,
    "archived": false,
    "openssf_score": 7.5,
    "true_bus_factor": 4,
    "bus_factor_confidence": "HIGH"
  },
  "openssf_checks": {
    "summary": {
      "Branch-Protection": {"score": 8, "status": "pass"},
      "Security-Policy": {"score": 9, "status": "pass"},
      "Code-Review": {"score": 5, "status": "partial"}
    },
    "all_checks": [...]
  },
  "confidence": {
    "score": 87.5,
    "level": "HIGH"
  }
}`
    }
  },
  {
    method: 'POST',
    path: '/v1/scan',
    description: 'Scan multiple packages from a package.json file.',
    auth: true,
    body: `{
  "dependencies": {
    "express": "^4.18.0",
    "lodash": "^4.17.21"
  }
}

// OR pass the entire package.json content:
{
  "content": "{ \\"dependencies\\": {...} }"
}`,
    example: {
      request: `curl -X POST -H "X-API-Key: YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"dependencies": {"express": "^4.0.0"}}' \\
  https://api.dephealth.laranjo.dev/v1/scan`,
      response: `{
  "total": 1,
  "critical": 0,
  "high": 0,
  "medium": 0,
  "low": 1,
  "packages": [
    {
      "package": "express",
      "ecosystem": "npm",
      "health_score": 83.5,
      "risk_level": "LOW",
      "abandonment_risk": {
        "probability": 3.5,
        "time_horizon_months": 12,
        "risk_factors": []
      },
      "components": {
        "maintainer_health": 85.2,
        "user_centric": 92.1,
        "evolution_health": 78.4,
        "community_health": 81.3,
        "security_health": 72.5
      }
    }
  ],
  "not_found": []
}`
    }
  },
  {
    method: 'GET',
    path: '/v1/usage',
    description: 'Get your current API usage and limits.',
    auth: true,
    example: {
      request: `curl -H "X-API-Key: YOUR_KEY" \\
  https://api.dephealth.laranjo.dev/v1/usage`,
      response: `{
  "tier": "free",
  "usage": {
    "requests_this_month": 42,
    "monthly_limit": 5000,
    "remaining": 4958,
    "usage_percentage": 0.8
  },
  "reset": {
    "date": "2026-02-01T00:00:00+00:00",
    "seconds_until_reset": 2087010
  }
}`
    }
  }
]

const riskLevels = [
  { level: 'LOW', score: '80-100', description: 'Package is healthy and well-maintained' },
  { level: 'MEDIUM', score: '60-79', description: 'Some concerns, monitor for changes' },
  { level: 'HIGH', score: '40-59', description: 'Significant risk factors present' },
  { level: 'CRITICAL', score: '0-39', description: 'Serious concerns, consider alternatives' }
]
---

<Layout title="API Documentation - DepHealth">
  <div class="max-w-5xl mx-auto px-4 sm:px-6">
    <Navbar />

    <main id="main-content" class="py-12">
      <h1 class="text-4xl font-bold mb-4">API Documentation</h1>
      <p class="text-xl text-zinc-400 mb-12">
        Everything you need to integrate DepHealth into your workflow.
      </p>

      <!-- Quick Start -->
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">1</span>
          Quick Start
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl p-6">
          <p class="text-zinc-400 mb-4">Get your API key and start checking packages:</p>
          <div class="bg-black/30 rounded-lg p-4 font-mono text-sm overflow-x-auto">
            <pre class="text-zinc-300"><code># Check a package
curl -H "X-API-Key: YOUR_KEY" \
  https://api.dephealth.laranjo.dev/v1/packages/npm/express</code></pre>
          </div>
        </div>
      </section>

      <!-- Authentication -->
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">2</span>
          Authentication
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl p-6">
          <p class="text-zinc-400 mb-4">
            Include your API key in the <code class="bg-black/30 px-2 py-1 rounded">X-API-Key</code> header:
          </p>
          <div class="bg-black/30 rounded-lg p-4 font-mono text-sm">
            <code class="text-zinc-300">X-API-Key: dh_your_api_key_here</code>
          </div>
          <p class="text-zinc-500 text-sm mt-4">
            Need an API key? <a href="/signup" class="text-blue-400 hover:underline">Get one free</a>
          </p>
        </div>
      </section>

      <!-- Base URL -->
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">3</span>
          Base URL
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl p-6">
          <div class="bg-black/30 rounded-lg p-4 font-mono text-sm">
            <code class="text-green-400">https://api.dephealth.laranjo.dev/v1</code>
          </div>
        </div>
      </section>

      <!-- Endpoints -->
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">4</span>
          Endpoints
        </h2>

        <div class="space-y-6">
          {endpoints.map((endpoint) => (
            <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl overflow-hidden">
              <!-- Header -->
              <div class="p-6 border-b border-[#1a1a1f]">
                <div class="flex items-center gap-3 mb-3">
                  <span class={`px-3 py-1 text-sm font-semibold rounded ${
                    endpoint.method === 'GET' ? 'bg-green-900/50 text-green-400' : 'bg-blue-900/50 text-blue-400'
                  }`}>
                    {endpoint.method}
                  </span>
                  <code class="text-lg">{endpoint.path}</code>
                  {endpoint.auth && (
                    <span class="px-2 py-0.5 text-xs bg-yellow-900/30 text-yellow-500 rounded">Auth Required</span>
                  )}
                </div>
                <p class="text-zinc-400">{endpoint.description}</p>
              </div>

              <!-- Parameters -->
              {endpoint.params && (
                <div class="p-6 border-b border-[#1a1a1f]">
                  <h3 class="text-sm font-semibold text-zinc-400 mb-3">Parameters</h3>
                  <div class="space-y-2">
                    {endpoint.params.map((param) => (
                      <div class="flex items-start gap-3 text-sm">
                        <code class="bg-black/30 px-2 py-1 rounded text-blue-400">{param.name}</code>
                        <span class="text-zinc-500">{param.type}</span>
                        <span class="text-zinc-400">{param.description}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <!-- Body -->
              {endpoint.body && (
                <div class="p-6 border-b border-[#1a1a1f]">
                  <h3 class="text-sm font-semibold text-zinc-400 mb-3">Request Body</h3>
                  <div class="bg-black/30 rounded-lg p-4 font-mono text-xs overflow-x-auto">
                    <pre class="text-zinc-300"><code>{endpoint.body}</code></pre>
                  </div>
                </div>
              )}

              <!-- Example -->
              <div class="p-6">
                <h3 class="text-sm font-semibold text-zinc-400 mb-3">Example</h3>
                <div class="space-y-4">
                  <div>
                    <span class="text-xs text-zinc-500 mb-2 block">Request</span>
                    <div class="bg-black/30 rounded-lg p-4 font-mono text-xs overflow-x-auto">
                      <pre class="text-zinc-300"><code>{endpoint.example.request}</code></pre>
                    </div>
                  </div>
                  <div>
                    <span class="text-xs text-zinc-500 mb-2 block">Response</span>
                    <div class="bg-black/30 rounded-lg p-4 font-mono text-xs overflow-x-auto">
                      <pre class="text-green-300"><code>{endpoint.example.response}</code></pre>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>

      <!-- Risk Levels -->
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">5</span>
          Risk Levels
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl overflow-hidden">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-6">
            {riskLevels.map((risk) => (
              <div class="text-center">
                <div class={`px-4 py-2 rounded-lg font-semibold mb-2 ${
                  risk.level === 'LOW' ? 'bg-green-900/50 text-green-400' :
                  risk.level === 'MEDIUM' ? 'bg-yellow-900/50 text-yellow-400' :
                  risk.level === 'HIGH' ? 'bg-orange-900/50 text-orange-400' :
                  'bg-red-900/50 text-red-400'
                }`}>
                  {risk.level}
                </div>
                <div class="text-sm text-zinc-400 mb-1">{risk.score}</div>
                <div class="text-xs text-zinc-500">{risk.description}</div>
              </div>
            ))}
          </div>
        </div>
      </section>

      <!-- Rate Limits -->
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">6</span>
          Rate Limits
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl p-6">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-zinc-400">
                <th scope="col" class="pb-4">Tier</th>
                <th scope="col" class="pb-4">Requests/Month</th>
                <th scope="col" class="pb-4">Price</th>
              </tr>
            </thead>
            <tbody class="text-zinc-300">
              <tr class="border-t border-[#1a1a1f]">
                <td class="py-4">Free</td>
                <td class="py-4">5,000</td>
                <td class="py-4">$0</td>
              </tr>
              <tr class="border-t border-[#1a1a1f]">
                <td class="py-4">Starter</td>
                <td class="py-4">25,000</td>
                <td class="py-4 text-zinc-500">Coming soon</td>
              </tr>
              <tr class="border-t border-[#1a1a1f]">
                <td class="py-4">Pro</td>
                <td class="py-4">100,000</td>
                <td class="py-4 text-zinc-500">Coming soon</td>
              </tr>
              <tr class="border-t border-[#1a1a1f]">
                <td class="py-4">Business</td>
                <td class="py-4">500,000</td>
                <td class="py-4 text-zinc-500">Coming soon</td>
              </tr>
            </tbody>
          </table>

          <div class="mt-6 p-4 bg-black/30 rounded-lg">
            <p class="text-sm text-zinc-400">
              Rate limit headers are included in every response:
            </p>
            <div class="mt-2 font-mono text-xs text-zinc-500">
              X-RateLimit-Limit: 5000<br>
              X-RateLimit-Remaining: 4958
            </div>
          </div>
        </div>
      </section>

      <!-- Errors -->
      <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">7</span>
          Error Handling
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl p-6">
          <p class="text-zinc-400 mb-4">All errors follow a consistent format:</p>
          <div class="bg-black/30 rounded-lg p-4 font-mono text-sm mb-6">
            <pre class="text-red-300"><code>{`{
  "error": {
    "code": "error_code",
    "message": "Human-readable error message"
  }
}`}</code></pre>
          </div>

          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-zinc-400">
                <th scope="col" class="pb-4">Status</th>
                <th scope="col" class="pb-4">Code</th>
                <th scope="col" class="pb-4">Description</th>
              </tr>
            </thead>
            <tbody class="text-zinc-300">
              <tr class="border-t border-[#1a1a1f]">
                <td class="py-3">401</td>
                <td class="py-3 font-mono text-xs">invalid_api_key</td>
                <td class="py-3 text-zinc-400">Missing or invalid API key</td>
              </tr>
              <tr class="border-t border-[#1a1a1f]">
                <td class="py-3">404</td>
                <td class="py-3 font-mono text-xs">package_not_found</td>
                <td class="py-3 text-zinc-400">Package not in our database</td>
              </tr>
              <tr class="border-t border-[#1a1a1f]">
                <td class="py-3">429</td>
                <td class="py-3 font-mono text-xs">rate_limit_exceeded</td>
                <td class="py-3 text-zinc-400">Monthly limit reached</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- CLI Tool -->
      <section id="cli-tool" class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">8</span>
          CLI Tool
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl p-6">
          <p class="text-zinc-400 mb-4">Install the CLI to check packages from your terminal:</p>
          <div class="bg-black/30 rounded-lg p-4 font-mono text-sm overflow-x-auto mb-4">
            <pre class="text-zinc-300"><code>npm install -g @dephealth/cli

# Check a single package
dephealth check express

# Scan your package.json
dephealth scan</code></pre>
          </div>
          <p class="text-zinc-500 text-sm">
            Configure your API key with <code class="bg-black/30 px-2 py-1 rounded">dephealth config --api-key YOUR_KEY</code>
          </p>
        </div>
      </section>

      <!-- GitHub Action -->
      <section id="github-action" class="mb-16">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">9</span>
          GitHub Action
        </h2>

        <div class="bg-[#111113] border border-[#1a1a1f] rounded-xl p-6">
          <p class="text-zinc-400 mb-4">Add dependency health checks to your CI/CD pipeline:</p>
          <div class="bg-black/30 rounded-lg p-4 font-mono text-sm overflow-x-auto">
            <pre class="text-zinc-300"><code># .github/workflows/dephealth.yml
name: Dependency Health Check
on: [push, pull_request]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Dlaranjo/dephealth@v1
        with:
          api-key: $&#123;&#123; secrets.DEPHEALTH_API_KEY &#125;&#125;
          fail-on: HIGH</code></pre>
          </div>
        </div>
      </section>
    </main>

    <Footer />
  </div>
</Layout>

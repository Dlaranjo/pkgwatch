---
// Normalize path by removing trailing slash (except for root)
const currentPath = Astro.url.pathname.replace(/\/$/, '') || '/';

// Helper to check if a path is active
const isActive = (path: string, exact = true) => {
  if (exact) return currentPath === path;
  return currentPath === path || currentPath.startsWith(path + '/');
};
---

<nav aria-label="Main navigation" class="fixed top-0 left-0 right-0 z-50 bg-[var(--color-bg-darker)]/80 backdrop-blur-lg border-b border-zinc-800/50">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
    <!-- Logo -->
    <a href="/" class="flex items-center gap-2">
      <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center p-1.5">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" class="w-full h-full">
          <ellipse cx="12" cy="12" rx="10" ry="6"/>
          <circle cx="12" cy="12" r="3" fill="white"/>
        </svg>
      </span>
      <span class="text-xl font-bold text-white">PkgWatch</span>
      <span class="px-2 py-0.5 text-xs bg-emerald-500/20 text-emerald-400 rounded-full">
        Live
      </span>
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden md:flex items-center gap-6">
      <a
        href="/what-is-pkgwatch"
        aria-current={isActive('/what-is-pkgwatch') ? 'page' : undefined}
        class={`text-sm transition-colors ${isActive('/what-is-pkgwatch') ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        About
      </a>
      <a
        href="/docs"
        aria-current={isActive('/docs', false) ? 'page' : undefined}
        class={`text-sm transition-colors ${isActive('/docs', false) ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        Docs
      </a>
      <a
        href="/methodology"
        aria-current={isActive('/methodology') ? 'page' : undefined}
        class={`text-sm transition-colors ${isActive('/methodology') ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        Methodology
      </a>
      <a
        href="/pricing"
        aria-current={isActive('/pricing') ? 'page' : undefined}
        class={`text-sm transition-colors ${isActive('/pricing') ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        Pricing
      </a>

      <!-- Logged-out state (default, visible) -->
      <a
        id="nav-cta-guest"
        href="/start"
        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition"
      >
        Get API Key
      </a>

      <!-- Logged-in state (hidden by default) -->
      <div id="nav-cta-user" class="hidden flex items-center gap-3">
        <a href="/dashboard" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition">
          Dashboard
        </a>
        <button id="nav-logout-btn" class="text-zinc-400 hover:text-white text-sm transition">
          Sign out
        </button>
      </div>
    </div>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-btn"
      class="md:hidden p-3 text-zinc-400 hover:text-white"
      aria-label="Toggle menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path
          id="menu-icon"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"
        />
        <path
          id="close-icon"
          class="hidden"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
  </div>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="hidden md:hidden border-t border-zinc-800/50 bg-[var(--color-bg-darker)]"
  >
    <div class="px-4 py-4 space-y-1">
      <a
        href="/what-is-pkgwatch"
        aria-current={isActive('/what-is-pkgwatch') ? 'page' : undefined}
        class={`block py-3 transition-colors ${isActive('/what-is-pkgwatch') ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        About
      </a>
      <a
        href="/docs"
        aria-current={isActive('/docs', false) ? 'page' : undefined}
        class={`block py-3 transition-colors ${isActive('/docs', false) ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        Docs
      </a>
      <a
        href="/methodology"
        aria-current={isActive('/methodology') ? 'page' : undefined}
        class={`block py-3 transition-colors ${isActive('/methodology') ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        Methodology
      </a>
      <a
        href="/pricing"
        aria-current={isActive('/pricing') ? 'page' : undefined}
        class={`block py-3 transition-colors ${isActive('/pricing') ? 'text-white font-medium' : 'text-zinc-400 hover:text-white'}`}
      >
        Pricing
      </a>

      <!-- Logged-out state (default, visible) -->
      <a
        id="mobile-cta-guest"
        href="/start"
        class="block w-full text-center px-4 py-2 bg-blue-500 hover:bg-blue-600
               text-white font-medium rounded-lg transition"
      >
        Get API Key
      </a>

      <!-- Logged-in state (hidden by default) -->
      <div id="mobile-cta-user" class="hidden flex flex-col gap-2 pt-2">
        <a
          href="/dashboard"
          class="block w-full text-center px-4 py-2 bg-blue-500 hover:bg-blue-600
                 text-white font-medium rounded-lg transition"
        >
          Dashboard
        </a>
        <button
          id="mobile-logout-btn"
          class="block w-full text-center px-4 py-2 text-zinc-400 hover:text-white transition"
        >
          Sign out
        </button>
      </div>
    </div>
  </div>
</nav>

<script>
  const API_BASE = 'https://api.pkgwatch.dev';
  const AUTH_CACHE_KEY = 'pkgwatch_auth_cache';

  // Type definitions
  interface PkgwatchUser {
    email: string;
    tier: string;
    [key: string]: unknown;
  }

  interface CachedAuth {
    isLoggedIn: boolean;
    user: PkgwatchUser | null;
    timestamp: number;
  }

  interface PkgwatchAuthState {
    isLoggedIn: boolean;
    user: PkgwatchUser | null;
    checked: boolean;
  }

  declare global {
    interface Window {
      pkgwatchAuth: PkgwatchAuthState;
    }
  }

  // Show logged-in UI
  function showLoggedInUI() {
    document.getElementById('nav-cta-guest')?.classList.add('hidden');
    document.getElementById('nav-cta-user')?.classList.remove('hidden');
    document.getElementById('mobile-cta-guest')?.classList.add('hidden');
    document.getElementById('mobile-cta-user')?.classList.remove('hidden');
  }

  // Show logged-out UI
  function showLoggedOutUI() {
    document.getElementById('nav-cta-guest')?.classList.remove('hidden');
    document.getElementById('nav-cta-user')?.classList.add('hidden');
    document.getElementById('mobile-cta-guest')?.classList.remove('hidden');
    document.getElementById('mobile-cta-user')?.classList.add('hidden');
  }

  // Get cached auth from sessionStorage
  function getCachedAuth(): CachedAuth | null {
    try {
      const cached = sessionStorage.getItem(AUTH_CACHE_KEY);
      return cached ? JSON.parse(cached) : null;
    } catch {
      return null;
    }
  }

  // Save auth to sessionStorage
  function setCachedAuth(isLoggedIn: boolean, user: PkgwatchUser | null) {
    try {
      const cache: CachedAuth = { isLoggedIn, user, timestamp: Date.now() };
      sessionStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(cache));
    } catch {
      // sessionStorage unavailable
    }
  }

  // Clear cached auth
  function clearCachedAuth() {
    try {
      sessionStorage.removeItem(AUTH_CACHE_KEY);
    } catch {}
  }

  // Main auth flow with optimistic rendering
  async function initAuth() {
    // 1. Check cache first for instant render (no flash)
    const cached = getCachedAuth();
    if (cached?.isLoggedIn) {
      showLoggedInUI();
      window.pkgwatchAuth = { isLoggedIn: true, user: cached.user, checked: false };
      window.dispatchEvent(new CustomEvent('auth-state-changed', {
        detail: { user: cached.user, fromCache: true }
      }));
    }

    // 2. Validate auth in background
    try {
      const response = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });

      if (response.ok) {
        const user = await response.json();
        setCachedAuth(true, user);
        window.pkgwatchAuth = { isLoggedIn: true, user, checked: true };

        // Update UI if we didn't have cache
        if (!cached?.isLoggedIn) {
          showLoggedInUI();
        }

        window.dispatchEvent(new CustomEvent('auth-state-changed', {
          detail: { user, fromCache: false }
        }));
      } else {
        // Not logged in - clear any stale cache
        clearCachedAuth();
        window.pkgwatchAuth = { isLoggedIn: false, user: null, checked: true };

        // Revert UI if cache was wrong
        if (cached?.isLoggedIn) {
          showLoggedOutUI();
        }

        window.dispatchEvent(new CustomEvent('auth-state-changed', {
          detail: { user: null, fromCache: false }
        }));
      }
    } catch {
      // Network error - keep cached state if available
      window.pkgwatchAuth = {
        isLoggedIn: cached?.isLoggedIn || false,
        user: cached?.user || null,
        checked: true
      };
      window.dispatchEvent(new CustomEvent('auth-state-changed', {
        detail: { user: cached?.user || null, fromCache: true }
      }));
    }
  }

  // Logout - clear cache and redirect
  async function handleLogout() {
    clearCachedAuth();
    try {
      await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' });
    } catch {}
    window.location.href = '/';
  }

  document.getElementById('nav-logout-btn')?.addEventListener('click', handleLogout);
  document.getElementById('mobile-logout-btn')?.addEventListener('click', handleLogout);

  // Initialize auth
  initAuth();

  // Mobile menu functionality
  const menuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');

  function closeMenu() {
    mobileMenu?.classList.add('hidden');
    menuIcon?.classList.remove('hidden');
    closeIcon?.classList.add('hidden');
    menuBtn?.setAttribute('aria-expanded', 'false');
    menuBtn?.focus();
  }

  function openMenu() {
    mobileMenu?.classList.remove('hidden');
    menuIcon?.classList.add('hidden');
    closeIcon?.classList.remove('hidden');
    menuBtn?.setAttribute('aria-expanded', 'true');
    const firstLink = mobileMenu?.querySelector('a');
    firstLink?.focus();
  }

  menuBtn?.addEventListener('click', () => {
    const isHidden = mobileMenu?.classList.contains('hidden');
    if (isHidden) {
      openMenu();
    } else {
      closeMenu();
    }
  });

  // Close menu on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !mobileMenu?.classList.contains('hidden')) {
      closeMenu();
    }
  });

</script>

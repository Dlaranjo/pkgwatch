---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Get Started | PkgWatch" mainClass="max-w-md mx-auto px-4 py-24 pt-24">
  <!-- Content hidden until auth check completes -->
  <div id="start-content" class="opacity-0 transition-opacity duration-150">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-white mb-4">Get Started with PkgWatch</h1>
      <p class="text-zinc-400">
        Enter your email to sign in or create an account
      </p>

      <!-- Referral bonus indicator (shown when referral code is active) -->
      <div id="referral-indicator" class="hidden mt-4 p-3 bg-emerald-900/30 border border-emerald-700 rounded-lg">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
          </svg>
          <span class="text-emerald-300 text-sm font-medium">You'll get <span id="referral-bonus">10,000</span> bonus requests!</span>
        </div>
      </div>
    </div>

    <form id="start-form" class="space-y-6">
      <div>
        <label for="email" class="block text-sm font-medium text-zinc-300 mb-2">
          Email Address
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          autocomplete="email"
          aria-describedby="error-message"
          class="w-full px-4 py-3 bg-[var(--color-bg-input)] border border-zinc-800 rounded-lg
                 text-white placeholder-zinc-500 focus:border-blue-500
                 focus:ring-1 focus:ring-blue-500 outline-none transition"
          placeholder="you@company.com"
        />
      </div>

      <button
        type="submit"
        class="w-full btn-gradient px-6 py-3 rounded-lg font-semibold
               text-white transition hover:opacity-90 disabled:opacity-50"
      >
        <span id="btn-text">Continue</span>
        <span id="btn-loading" class="hidden">Sending...</span>
      </button>

      <p id="error-message" class="text-red-400 text-sm hidden" role="alert" aria-live="polite"></p>
      <p id="success-message" class="text-emerald-400 text-sm hidden" role="status" aria-live="polite"></p>

      <!-- Resend email (shown after success) -->
      <div id="resend-container" class="hidden mt-4 p-4 bg-zinc-900/50 border border-zinc-800 rounded-lg">
        <p class="text-zinc-400 text-sm mb-3">
          Didn't receive the email? Check your spam folder first, then try resending.
        </p>
        <button
          id="resend-btn"
          type="button"
          class="text-blue-400 hover:text-blue-300 text-sm font-medium underline underline-offset-2 disabled:opacity-50 disabled:no-underline disabled:cursor-not-allowed"
        >
          <span id="resend-text">Resend email</span>
          <span id="resend-cooldown" class="hidden"></span>
        </button>
      </div>

      <!-- Account recovery link -->
      <div class="mt-6 pt-6 border-t border-zinc-800 text-center">
        <a href="/recover" class="text-zinc-500 hover:text-zinc-400 text-sm transition">
          Can't access your email?
        </a>
      </div>
    </form>
  </div>
</Layout>

<script>
  import { API_BASE } from '../config';
  const AUTH_CACHE_KEY = 'pkgwatch_auth_cache';
  const REFERRAL_CODE_KEY = 'pkgwatch_referral_code';

  // Capture and store referral code from URL
  function captureReferralCode(): string | null {
    const params = new URLSearchParams(window.location.search);
    const refCode = params.get('ref');

    if (refCode && /^[a-zA-Z0-9]{6,12}$/.test(refCode)) {
      // Store in localStorage (persists across sessions)
      localStorage.setItem(REFERRAL_CODE_KEY, refCode);
      // Clean up URL (remove ref param)
      const newParams = new URLSearchParams(window.location.search);
      newParams.delete('ref');
      const newUrl = newParams.toString() ? `/start?${newParams}` : '/start';
      window.history.replaceState({}, '', newUrl);
      return refCode;
    }

    // Check localStorage for previously stored code
    return localStorage.getItem(REFERRAL_CODE_KEY);
  }

  // Show referral indicator if code exists
  const activeReferralCode = captureReferralCode();
  if (activeReferralCode) {
    const indicator = document.getElementById('referral-indicator');
    indicator?.classList.remove('hidden');
  }

  // Check cache first for instant redirect (no flash)
  const cached = sessionStorage.getItem(AUTH_CACHE_KEY);
  if (cached) {
    try {
      const auth = JSON.parse(cached);
      if (auth.isLoggedIn) {
        // Hide everything during redirect to prevent any flash
        document.body.style.visibility = 'hidden';
        window.location.href = '/dashboard';
      }
    } catch {}
  }

  // Listen for auth validation from Navbar
  window.addEventListener('auth-state-changed', (e: Event) => {
    const detail = (e as CustomEvent).detail;
    if (detail?.user && !detail?.fromCache) {
      // Validated as logged in - redirect
      document.body.style.visibility = 'hidden';
      window.location.href = '/dashboard';
    } else if (!detail?.user && !detail?.fromCache) {
      // Validated as logged out - show form
      document.getElementById('start-content')?.classList.remove('opacity-0');
    }
  });

  // If no cache, wait for validation then show form
  if (!cached && window.pkgwatchAuth?.checked && !window.pkgwatchAuth.isLoggedIn) {
    document.getElementById('start-content')?.classList.remove('opacity-0');
  }

  // Store redirect URL for after login (e.g., from /start?redirect=/pricing)
  // Prevent protocol-relative URLs like //evil.com which would redirect to external sites
  const redirectParam = new URLSearchParams(window.location.search).get('redirect');
  if (redirectParam && /^\/[^\/]/.test(redirectParam)) {
    sessionStorage.setItem('pkgwatch_redirect', redirectParam);
  }

  const form = document.getElementById('start-form');
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const errorMsg = document.getElementById('error-message');
  const successMsg = document.getElementById('success-message');

  // Resend elements
  const resendContainer = document.getElementById('resend-container');
  const resendBtn = document.getElementById('resend-btn') as HTMLButtonElement;
  const resendText = document.getElementById('resend-text');
  const resendCooldown = document.getElementById('resend-cooldown');

  // State
  let lastSubmittedEmail = '';
  let resendTimeoutId: number | null = null;
  let buttonCooldownTimeoutId: number | null = null;
  let resendCooldownTimeoutId: number | null = null;

  // Cleanup function to prevent memory leaks on navigation
  function cleanupTimeouts(): void {
    if (resendTimeoutId) clearTimeout(resendTimeoutId);
    if (buttonCooldownTimeoutId) clearTimeout(buttonCooldownTimeoutId);
    if (resendCooldownTimeoutId) clearTimeout(resendCooldownTimeoutId);
  }
  window.addEventListener('beforeunload', cleanupTimeouts);

  // Predefined error messages (prevents URL-based phishing)
  // Flow-agnostic messages that work for both signup and login
  const ERROR_MESSAGES: Record<string, string> = {
    'invalid_token': 'Invalid or expired link. Please try again.',
    'token_expired': 'Your link has expired. Please try again.',
    'token_already_used': 'This link has already been used. Please try again.',
    'email_exists': 'An account with this email already exists. Please try again.',
    'missing_token': 'Link token is required.',
    'internal_error': 'Something went wrong. Please try again.',
  };

  // Check for error params from callback redirects
  function handleErrorParams(): void {
    const params = new URLSearchParams(window.location.search);
    const errorCode = params.get('error');

    if (errorCode && errorMsg) {
      const message = ERROR_MESSAGES[errorCode] || 'An error occurred. Please try again.';
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
      // Clean up URL (preserve redirect param if present)
      const redirect = params.get('redirect');
      const newUrl = redirect ? `/start?redirect=${encodeURIComponent(redirect)}` : '/start';
      window.history.replaceState({}, '', newUrl);
    }
  }

  // Run on page load
  handleErrorParams();

  // Show resend option after delay
  function showResendAfterDelay(delayMs: number = 30000): void {
    if (resendTimeoutId) {
      clearTimeout(resendTimeoutId);
    }
    resendTimeoutId = window.setTimeout(() => {
      resendContainer?.classList.remove('hidden');
    }, delayMs);
  }

  // Handle button cooldown after success
  function startButtonCooldown(seconds: number): void {
    if (!submitBtn || !btnText) return;

    // Clear any existing cooldown
    if (buttonCooldownTimeoutId) {
      clearTimeout(buttonCooldownTimeoutId);
    }

    submitBtn.disabled = true;
    let remaining = seconds;

    const updateCooldown = () => {
      btnText.textContent = `Submit again in ${remaining}s`;
      remaining--;

      if (remaining < 0) {
        submitBtn.disabled = false;
        btnText.textContent = 'Continue';
        buttonCooldownTimeoutId = null;
      } else {
        buttonCooldownTimeoutId = window.setTimeout(updateCooldown, 1000);
      }
    };
    updateCooldown();
  }

  // Handle resend cooldown UI
  function startResendCooldown(seconds: number): void {
    if (!resendBtn || !resendText || !resendCooldown) return;

    // Clear any existing cooldown
    if (resendCooldownTimeoutId) {
      clearTimeout(resendCooldownTimeoutId);
    }

    resendBtn.disabled = true;
    resendText.classList.add('hidden');
    resendCooldown.classList.remove('hidden');

    let remaining = seconds;
    const updateCooldown = () => {
      if (resendCooldown) {
        resendCooldown.textContent = `Wait ${remaining}s to resend`;
      }
      remaining--;

      if (remaining < 0) {
        // Cooldown complete
        resendBtn.disabled = false;
        resendText?.classList.remove('hidden');
        resendCooldown?.classList.add('hidden');
        resendCooldownTimeoutId = null;
      } else {
        resendCooldownTimeoutId = window.setTimeout(updateCooldown, 1000);
      }
    };
    updateCooldown();
  }

  // Handle resend click - uses same /signup endpoint which handles all cases
  async function handleResend(): Promise<void> {
    if (!lastSubmittedEmail) return;

    // Disable button immediately
    if (resendBtn) resendBtn.disabled = true;
    errorMsg?.classList.add('hidden');

    try {
      // Use /signup endpoint which handles new users, pending users, and existing users
      const response = await fetch(`${API_BASE}/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: lastSubmittedEmail }),
      });

      const data = await response.json();

      if (response.ok) {
        if (successMsg) successMsg.textContent = data.message || 'Email sent! Check your inbox.';
        successMsg?.classList.remove('hidden');
        // Start 60-second cooldown
        startResendCooldown(60);
      } else if (response.status === 429) {
        // Cooldown error from server - extract remaining seconds
        const match = data.error?.message?.match(/(\d+) seconds/);
        const remaining = match ? parseInt(match[1]) : 60;
        startResendCooldown(remaining);
        if (errorMsg) errorMsg.textContent = data.error?.message || 'Please wait before requesting another email.';
        errorMsg?.classList.remove('hidden');
      } else {
        if (errorMsg) errorMsg.textContent = data.error?.message || 'Failed to resend email.';
        errorMsg?.classList.remove('hidden');
        if (resendBtn) resendBtn.disabled = false;
      }
    } catch (error) {
      if (errorMsg) errorMsg.textContent = 'Network error. Please try again.';
      errorMsg?.classList.remove('hidden');
      if (resendBtn) resendBtn.disabled = false;
    }
  }

  // Main form submit handler - uses unified /signup endpoint
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = emailInput?.value || '';
    lastSubmittedEmail = email;

    // Hide resend container and reset state
    resendContainer?.classList.add('hidden');
    if (resendTimeoutId) {
      clearTimeout(resendTimeoutId);
      resendTimeoutId = null;
    }

    // Disable button and show loading state
    if (submitBtn) submitBtn.disabled = true;
    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    errorMsg?.classList.add('hidden');
    successMsg?.classList.add('hidden');

    try {
      // Use /signup endpoint which intelligently handles:
      // - New users: creates pending account, sends verification email
      // - Existing users: sends magic link
      // - Pending users: resends verification email (with cooldown)
      const signupBody: { email: string; referral_code?: string } = { email };

      // Include referral code if available
      const storedReferralCode = localStorage.getItem(REFERRAL_CODE_KEY);
      if (storedReferralCode) {
        signupBody.referral_code = storedReferralCode;
      }

      const response = await fetch(`${API_BASE}/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(signupBody),
      });

      const data = await response.json();

      if (response.ok) {
        if (successMsg) successMsg.textContent = data.message || 'Check your email (including spam folder) for a link to continue!';
        successMsg?.classList.remove('hidden');
        form?.reset();
        // Clear referral code after successful signup (it was included in the request)
        localStorage.removeItem(REFERRAL_CODE_KEY);
        // Show resend option after 30 seconds
        showResendAfterDelay(30000);
        // Start button cooldown
        btnLoading?.classList.add('hidden');
        btnText?.classList.remove('hidden');
        startButtonCooldown(30);
      } else {
        if (errorMsg) errorMsg.textContent = data.error?.message || 'Something went wrong';
        errorMsg?.classList.remove('hidden');
        // Re-enable button on error
        if (submitBtn) submitBtn.disabled = false;
        btnText?.classList.remove('hidden');
        btnLoading?.classList.add('hidden');
      }
    } catch (error) {
      if (errorMsg) errorMsg.textContent = 'Network error. Please try again.';
      errorMsg?.classList.remove('hidden');
      // Re-enable button on error
      if (submitBtn) submitBtn.disabled = false;
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  });

  // Resend button click handler
  resendBtn?.addEventListener('click', handleResend);
</script>

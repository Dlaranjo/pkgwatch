---
import Layout from '../layouts/Layout.astro'

const colorClasses: Record<string, string> = {
  blue: 'bg-blue-500',
  green: 'bg-green-500',
  purple: 'bg-purple-500',
  red: 'bg-red-500',
  orange: 'bg-orange-500'
}

const components = [
  {
    name: 'User-Centric',
    weight: 30,
    color: 'blue',
    description: 'Adoption metrics - most predictive of package health',
    signals: ['Weekly downloads', 'Dependent packages', 'GitHub stars']
  },
  {
    name: 'Maintainer Health',
    weight: 25,
    color: 'green',
    description: 'Active maintenance and sustainability',
    signals: ['Days since last commit', 'True bus factor (contribution distribution)', 'PR merge velocity']
  },
  {
    name: 'Evolution',
    weight: 20,
    color: 'purple',
    description: 'Development momentum with maturity adjustment',
    signals: ['Release recency', 'Commit activity', 'Maturity factor for stable packages']
  },
  {
    name: 'Security',
    weight: 15,
    color: 'red',
    description: 'Security posture and vulnerability status',
    signals: ['OpenSSF Scorecard', 'Known vulnerabilities', 'Security policy presence']
  },
  {
    name: 'Community',
    weight: 10,
    color: 'orange',
    description: 'Contributor diversity and engagement',
    signals: ['Total contributors', 'Issue response time']
  }
]
---

<Layout title="Scoring Methodology | PkgWatch" mainClass="pt-24 pb-16">
  <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-white mb-4">Scoring Methodology</h1>
        <p class="text-xl text-zinc-400">
          How PkgWatch calculates health scores and predicts abandonment risk
        </p>
      </div>

      <!-- Component Weights Visual -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold text-white mb-6">Component Weights</h2>
        <p class="text-zinc-400 mb-6">
          The health score (0-100) is a weighted combination of five components:
        </p>

        <div class="space-y-4 mb-8">
          {components.map(c => (
            <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium text-white">{c.name}</span>
                <span class="text-zinc-400">{c.weight}%</span>
              </div>
              <div class="w-full bg-zinc-700 rounded-full h-2 mb-3">
                <div class={`${colorClasses[c.color]} h-2 rounded-full`} style={`width: ${c.weight}%`}></div>
              </div>
              <p class="text-sm text-zinc-400 mb-2">{c.description}</p>
              <div class="flex flex-wrap gap-2">
                {c.signals.map(signal => (
                  <span class="text-xs bg-zinc-700 text-zinc-300 px-2 py-1 rounded">{signal}</span>
                ))}
              </div>
            </div>
          ))}
        </div>
      </section>

      <!-- Mathematical Functions -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold text-white mb-6">How We Score</h2>

        <div class="space-y-6">
          <!-- Exponential Decay -->
          <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
            <h3 class="text-lg font-medium text-white mb-3">Recency Signals</h3>
            <p class="text-zinc-400 mb-4">
              We use exponential decay functions so scores decrease smoothly over time, not in sudden steps.
            </p>
            <ul class="text-sm text-zinc-400 space-y-2">
              <li><span class="text-zinc-300">Commit recency:</span> 90-day half-life (50% score after 90 days inactive)</li>
              <li><span class="text-zinc-300">Release recency:</span> 180-day half-life (more lenient for stable releases)</li>
            </ul>
          </div>

          <!-- Bus Factor -->
          <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
            <h3 class="text-lg font-medium text-white mb-3">True Bus Factor</h3>
            <p class="text-zinc-400 mb-4">
              We analyze commit distribution to find the minimum contributors needed for 50% of commits.
              A project with 10 contributors where 1 person does 95% of work has a bus factor of 1, not 10.
            </p>
            <div class="text-sm text-zinc-400">
              <span class="text-zinc-300">Interpretation:</span>
              <ul class="mt-2 space-y-1 ml-4">
                <li>Bus factor 1: High risk - single point of failure</li>
                <li>Bus factor 2-3: Moderate risk - small team</li>
                <li>Bus factor 4+: Lower risk - distributed contributions</li>
              </ul>
            </div>
          </div>

          <!-- Maturity Factor -->
          <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
            <h3 class="text-lg font-medium text-white mb-3">Maturity Factor</h3>
            <p class="text-zinc-400 mb-4">
              High-adoption packages with low activity aren't penalized - they're likely stable, not abandoned.
              Packages like <code class="text-zinc-300 bg-zinc-700 px-1 rounded">lodash</code> benefit from this.
            </p>
            <p class="text-sm text-zinc-400">
              <span class="text-zinc-300">Criteria:</span> 1M+ weekly downloads OR 5K+ dependents with &lt;10 commits/90d
            </p>
          </div>

          <!-- Security -->
          <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
            <h3 class="text-lg font-medium text-white mb-3">Security Assessment</h3>
            <p class="text-zinc-400 mb-4">
              We integrate OpenSSF Scorecard data and track known vulnerabilities by severity.
            </p>
            <div class="text-sm text-zinc-400 space-y-2">
              <p><span class="text-zinc-300">OpenSSF Scorecard (50%):</span> Automated security practices assessment</p>
              <p><span class="text-zinc-300">Vulnerabilities (30%):</span> CRITICAL=3x, HIGH=2x, MEDIUM=1x weight</p>
              <p><span class="text-zinc-300">Security Policy (20%):</span> Has SECURITY.md with disclosure process</p>
            </div>
          </div>

          <!-- PR Merge Velocity -->
          <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
            <h3 class="text-lg font-medium text-white mb-3">PR Merge Velocity</h3>
            <p class="text-zinc-400 mb-4">
              Measures maintainer responsiveness by tracking the ratio of merged to opened pull requests over the last 90 days.
            </p>
            <div class="text-sm text-zinc-400">
              <span class="text-zinc-300">Interpretation:</span>
              <ul class="mt-2 space-y-1 ml-4">
                <li>&gt;80% merge rate: High maintainer responsiveness</li>
                <li>~50% merge rate: Moderate maintainer engagement</li>
                <li>&lt;30% merge rate: Potential maintainer overload or abandonment</li>
                <li>No PRs: Neutral score (could indicate stable package)</li>
              </ul>
            </div>
          </div>

          <!-- Issue Response Time -->
          <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
            <h3 class="text-lg font-medium text-white mb-3">Issue Response Time</h3>
            <p class="text-zinc-400 mb-4">
              Fast issue response time is a strong indicator of maintainer engagement and project health.
            </p>
            <div class="text-sm text-zinc-400">
              <span class="text-zinc-300">Scoring:</span>
              <ul class="mt-2 space-y-1 ml-4">
                <li>&lt;24 hours: Perfect score (1.0)</li>
                <li>24-72 hours: High score (0.7-1.0)</li>
                <li>&gt;72 hours: Exponential decay</li>
                <li>No data: Neutral score (0.5)</li>
              </ul>
            </div>
            <div class="mt-4 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg text-sm">
              <span class="text-amber-400 font-medium">Data Note:</span>
              <span class="text-zinc-400 ml-1">
                Response times are currently estimated using heuristics based on issue comment presence
                (24h for closed issues with comments, 48h for open issues with comments).
                Direct timeline data will be added in a future update.
              </span>
            </div>
          </div>

          <!-- Bot Commit Filtering -->
          <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
            <h3 class="text-lg font-medium text-white mb-3">Bot Commit Filtering</h3>
            <p class="text-zinc-400 mb-4">
              We filter out commits from known bot accounts (Dependabot, Renovate, etc.) to get accurate human activity metrics.
            </p>
            <p class="text-sm text-zinc-400">
              <span class="text-zinc-300">Why it matters:</span> Bot commits can artificially inflate activity metrics. We analyze real human contributions for more accurate health assessment.
            </p>
          </div>
        </div>
      </section>

      <!-- Risk Levels -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold text-white mb-6">Risk Levels</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-400 mb-1">LOW</div>
            <div class="text-sm text-zinc-400">80-100</div>
            <div class="text-xs text-zinc-500 mt-2">Healthy, well-maintained</div>
          </div>
          <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-yellow-400 mb-1">MEDIUM</div>
            <div class="text-sm text-zinc-400">60-79</div>
            <div class="text-xs text-zinc-500 mt-2">Monitor for changes</div>
          </div>
          <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-orange-400 mb-1">HIGH</div>
            <div class="text-sm text-zinc-400">40-59</div>
            <div class="text-xs text-zinc-500 mt-2">Significant concerns</div>
          </div>
          <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-red-400 mb-1">CRITICAL</div>
            <div class="text-sm text-zinc-400">0-39</div>
            <div class="text-xs text-zinc-500 mt-2">Serious issues</div>
          </div>
        </div>
      </section>

      <!-- Data Sources -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold text-white mb-6">Data Sources</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
            <h3 class="font-medium text-white mb-2">deps.dev</h3>
            <p class="text-sm text-zinc-400">Primary source for dependencies, dependents, advisories, OpenSSF scores</p>
          </div>
          <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
            <h3 class="font-medium text-white mb-2">npm Registry</h3>
            <p class="text-sm text-zinc-400">Downloads, maintainers, deprecation status, release dates</p>
          </div>
          <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
            <h3 class="font-medium text-white mb-2">PyPI Registry</h3>
            <p class="text-sm text-zinc-400">Python package metadata, downloads, maintainers, classifiers</p>
          </div>
          <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
            <h3 class="font-medium text-white mb-2">GitHub API</h3>
            <p class="text-sm text-zinc-400">Commits, contributors, stars, issue response times, PR merge velocity</p>
          </div>
        </div>
      </section>

      <!-- Confidence -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold text-white mb-6">Confidence Levels & Intervals</h2>
        <p class="text-zinc-400 mb-4">
          Every score includes a confidence level and interval indicating data reliability:
        </p>
        <ul class="text-zinc-400 space-y-2 mb-4">
          <li><span class="text-green-400 font-medium">HIGH:</span> Complete data, package &gt;1 year old, recently updated (±5 point interval)</li>
          <li><span class="text-yellow-400 font-medium">MEDIUM:</span> Some data missing or package 6-12 months old (±10 point interval)</li>
          <li><span class="text-orange-400 font-medium">LOW:</span> Significant data gaps or stale information (±15 point interval)</li>
          <li><span class="text-red-400 font-medium">INSUFFICIENT_DATA:</span> Package &lt;90 days old - scores unreliable</li>
        </ul>
        <p class="text-sm text-zinc-400">
          <span class="text-zinc-300">Confidence intervals:</span> Wider intervals for lower data quality reflect increased uncertainty. A score of 75 with HIGH confidence has an interval of [70, 80], while LOW confidence might be [60, 90].
        </p>
      </section>

      <!-- Limitations -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold text-white mb-6">Limitations</h2>
        <div class="bg-zinc-800/50 rounded-lg p-6 border border-zinc-700/50">
          <p class="text-zinc-400 mb-4">PkgWatch does <span class="text-white">NOT</span> measure:</p>
          <ul class="text-zinc-400 space-y-2">
            <li>Code quality or test coverage</li>
            <li>API stability or breaking changes</li>
            <li>Actual usage patterns in your codebase</li>
            <li>Zero-day vulnerabilities not in public databases</li>
            <li>Commercial support availability</li>
          </ul>
          <p class="text-zinc-400 mt-4">
            Scores are <span class="text-white">advisory</span> - always review packages manually before making critical decisions.
          </p>
        </div>
      </section>

      <!-- Changelog -->
      <section>
        <h2 class="text-2xl font-semibold text-white mb-6">Changelog</h2>
        <div class="space-y-4">
          <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
            <div class="flex justify-between items-center mb-2">
              <span class="font-medium text-white">v3.0 - January 2026</span>
              <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">Current</span>
            </div>
            <ul class="text-sm text-zinc-400 space-y-1">
              <li>Added issue response time signal to Community Health</li>
              <li>Added PR merge velocity signal to Maintainer Health</li>
              <li>Improved abandonment risk with Weibull survival analysis</li>
              <li>Added confidence intervals based on data quality</li>
              <li>Bot commit filtering for accurate activity metrics</li>
            </ul>
          </div>
          <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
            <span class="font-medium text-white">v2.0 - January 2026</span>
            <ul class="text-sm text-zinc-400 space-y-1 mt-2">
              <li>Added Security as 5th component (15% weight)</li>
              <li>True bus factor from contribution distribution</li>
              <li>Maturity factor for stable packages</li>
              <li>Individual OpenSSF checks exposed in API</li>
              <li>Rebalanced weights (Maintainer 25%, Evolution 20%, Community 10%)</li>
            </ul>
          </div>
          <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
            <span class="font-medium text-white">v1.0 - December 2025</span>
            <p class="text-sm text-zinc-400 mt-1">Initial release with 4-component scoring</p>
          </div>
        </div>
      </section>
    </div>
</Layout>
